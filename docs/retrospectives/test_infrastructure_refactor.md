# 개발 회고록: 모래성에서 요새로 - 테스트 인프라 혁명

## 1. 서론: 왜 우리는 도시를 재개발해야 했는가?
- 최초의 문제: `ModuleNotFoundError`라는 유령의 등장
- 돌다리를 두드리는 심정: 불안정했던 `unittest` 환경의 한계
- 목표의 전환: 단일 버그 수정에서 인프라 전체 재설계로

## 2. 도시 계획: `pytest` 기반의 견고한 인프라 설계

우리가 마주한 `ModuleNotFoundError`는 단순한 버그가 아니었다. 그것은 도시의 주소 체계가 완전히 무너져, 시민(모듈)들이 서로의 집을 찾지 못하는 근본적인 문제와 같았다. 우리는 이 문제를 해결하기 위해, 다음과 같은 세 가지 핵심 도구를 사용하여 도시를 처음부터 다시 계획했다.

### **청사진 (`setup.py`): 프로젝트를 하나의 '국가'로 선포하기**

가장 먼저 한 일은 `setup.py` 파일을 만들어, 흩어져 있던 코드들을 '엘리시아'라는 하나의 공식적인 패키지(국가)로 선포한 것이다. 이전에는 각 파일들이 자신이 어디에 속해 있는지 모르는 '유랑민'과 같았다면, `setup.py`는 그들에게 '엘리시아 국민'이라는 소속감을 부여하고, 파이썬 인터프리터가 "아, 이 코드들은 모두 '엘리시아'라는 한 나라의 일부이군!"이라고 명확히 인지하게 만들었다. `pip install -e .` 명령어를 통해 이 '국가'를 개발 모드로 설치하면, 모든 시민(모듈)들은 마침내 자신의 정확한 주소(`Project_Sophia.cognition_pipeline` 등)를 갖게 된다.

### **도로 교통법 (`pytest.ini`): `pytest`에게 도시의 구조를 알리는 법**

'국가'를 선포했지만, 훌륭한 교통 시스템(`pytest`)이 도시의 어디에 도로를 놓아야 할지 알려주지 않으면 무용지물이다. `pytest.ini` 파일은 바로 이 `pytest`를 위한 '도로 교통법'과 같다. 우리는 여기에 `pythonpath = . Project_Sophia`라고 명시하여, "모든 길은 수도(`.` 루트)와 핵심 도시(`Project_Sophia`)로 통한다"는 규칙을 알려주었다. 덕분에 `pytest`는 더 이상 길을 헤매지 않고, 도시의 모든 곳(`tests` 포함)을 누비며 자신의 임무(테스트 실행)를 수행할 수 있게 되었다.

### **공공 시설 (`conftest.py`): 'Mock 조립 공장'을 건설하여 테스트 부품 표준화하기**

마지막으로, 우리는 `tests/conftest.py`라는 '공공 시설'을 건설했다. 이곳의 가장 중요한 역할은 'Mock 조립 공장'(`shared_pipeline` fixture)이다. 이 공장은 테스트가 시작될 때마다, 실제 `CognitionPipeline`의 부품 중 무겁고 예측 불가능한 `LocalLLMCortex`를, 가볍고 일관된 `MockLocalLLMCortex`라는 '표준 부품'으로 교체한 '테스트용 파이프라인'을 생산하여 각 테스트에 공급한다. 덕분에 모든 테스트는 외부 환경의 영향 없이, 오직 내부 로직만을 빠르고 정확하게 검증할 수 있는, 완벽하게 통제된 환경에서 수행될 수 있게 되었다.

이 세 가지 핵심 인프라를 통해, 우리는 마침내 `ModuleNotFoundError`라는 유령을 완전히 추방하고, 그 어떤 변화에도 흔들리지 않는 견고한 테스트 고속도로를 개통할 수 있었다.

## 3. 건축 시공: 의존성 주입을 통한 예측 가능한 건물 설계

견고한 도시 계획 위에서도, 건물(`InquisitiveMind`)이 제멋대로 외부 자재(`gemini_api`)를 끌어다 쓰는 문제가 발생했다. 이는 테스트 도시 전체의 예측 가능성을 뒤흔드는 심각한 문제였다.

- **문제:** `InquisitiveMind`는 왜 자꾸 멋대로 행동했을까?
  - `InquisitiveMind`는 내부에서 직접 `LocalLLMCortex`를 생성하고, `gemini_api`를 호출했다. 이는 마치 건물이 설계도와 상관없이 스스로 자재를 주문하고 증축하는 것과 같았다. 테스트 환경에서는 이 행동을 통제할 방법이 없었다.

- **해결:** 생성자 주입(Constructor Injection)을 통한 제어권 확보
  - 우리는 `InquisitiveMind`의 생성자(`__init__`)를 수정하여, 필요한 `llm_cortex`를 외부에서 '주입'받도록 변경했다.
  - 이제 `CognitionPipeline`은 자신이 사용하는 `LocalLLMCortex`를 `InquisitiveMind`에 직접 지급하며, 모든 통제권을 갖게 되었다.
  - 'Mock 조립 공장'(`conftest.py`)에서는 이 원리를 활용하여, 실제 `llm_cortex` 대신 `MockLocalLLMCortex`를 주입함으로써, `InquisitiveMind`의 모든 행동을 완벽하게 예측하고 검증할 수 있게 되었다.

- **교훈:** '느슨한 결합(Loose Coupling)'의 중요성
  - 이번 경험을 통해 우리는 모듈이 자신의 의존성을 직접 생성하는 '강한 결합'이 테스트를 얼마나 어렵게 만드는지 깨달았다. 의존성을 외부에서 주입하는 '느슨한 결합'이야말로, 유연하고 테스트하기 쉬운 시스템을 만드는 핵심 설계 원칙이다.

## 4. 버그 수정 실록: 디버깅 여정의 주요 전투 기록

이번 재개발 프로젝트는 수많은 전투의 연속이었다. 그중 미래의 에이전트들에게 가장 큰 교훈을 줄 세 가지 전투를 기록한다.

- **`CognitionPipeline` 라우팅 전투:** 잘못된 주소로 배달되던 '수학 편지'
  - **문제:** "5 * 3은?"이라는 명백한 수학 질문이 `ArithmeticCortex`로 가지 않고, `InquisitiveMind`에게 '새로운 지식'으로 분류되는 어처구니없는 일이 발생했다.
  - **원인:** `ArithmeticCortex`는 "5*3"과 같은 순수 표현식만 이해할 뿐, 자연어를 해석하는 기능이 없었다. `CognitionPipeline`은 처리할 수 없는 편지라고 판단하여 이를 `InquisitiveMind`로 보낸 것이다.
  - **해결:** `ArithmeticCortex`에 정규 표현식을 사용한 `process` 메서드를 추가하여, 자연어 질문 속에서 '수학 편지'를 스스로 인식하고 처리할 수 있는 능력을 부여했다.

- **`requirements.txt` 빌드 전쟁:** `numpy`, `scikit-learn`과의 기나긴 싸움
  - **문제:** `start.sh`를 실행할 때마다 `numpy`와 `scikit-learn`이 `AttributeError: module 'pkgutil' has no attribute 'ImpImporter'` 오류를 내뿜으며 설치에 실패했다.
  - **원인:** `pip`, `setuptools`, 그리고 각 라이브러리 버전 간의 복잡한 비호환성 문제였다.
  - **해결:** `pip`을 최신 버전으로 업그레이드하고, `setuptools`의 버전을 안정적인 버전으로 고정했으며, `numpy`와 `scikit-learn`을 최신 파이썬 환경과 호환되는 버전으로 업그레이드하는 길고 긴 사투 끝에 마침내 빌드에 성공했다.

- **우리가 사용한 무기:** 비유와 은유를 통한 창의적 문제 해결
  - 이번 여정에서 가장 강력했던 무기는 바로 '비유와 은유'였다. 복잡한 소프트웨어 문제를 '도시 계획', '건축', '교통 시스템'에 비유함으로써, 우리는 문제의 본질을 명확히 꿰뚫고, 창의적인 해결책을 함께 찾아 나갈 수 있었다.

## 5. 결론: 이제 우리는 요새 위에서 무엇을 할 것인가?

우리는 모래성을 허물고 요새를 지었다. 이 견고한 테스트 인프라는 단순한 버그 수정의 결과물이 아니라, 엘리시아 프로젝트의 미래를 위한 초석이다. 이제 우리는 오류에 대한 두려움 없이, 더 빠르고, 더 안정적이며, 더 예측 가능한 방식으로 새로운 기능을 추가하고 시스템을 확장해 나갈 수 있다.

**미래의 에이전트들에게:**

이 문서는 단순한 기록이 아니라, 우리가 남기는 유산이다. 벽에 부딪혔을 때, 이 회고록에 담긴 비유와 은유를 통해 문제의 본질을 꿰뚫는 지혜를 얻길 바란다. 우리가 건설한 이 견고한 요새 위에서, 우리보다 더 높은 곳으로, 더 원대한 꿈을 향해 나아가라.


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elysia Chat</title>
  <style>
    body { background:#1a1a1a; color:#e0e0e0; font-family: Arial, sans-serif; margin:0; height:100vh; display:flex; justify-content:center; align-items:center; }
    .container { width:96%; max-width:1600px; height:90vh; background:#2a2a2a; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,.5); display:flex; overflow:auto; position:relative; }
    .chat-panel { flex:2; display:flex; flex-direction:column; padding:20px; }
    .header { padding-bottom:10px; border-bottom:1px solid #444; margin-bottom:10px; text-align:center; }
    .header h1 { margin:0; font-size:1.5em; }
    .messages { flex:1; overflow-y:auto; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px; }
    .message { margin-bottom:12px; }
    .message.user { text-align:right; color:#88c0d0; }
    .message.elysia { color:#b48ead; }
    /* New style for hypothesis questions */
    .message.hypothesis { background-color: #3d3d3d; border-left: 3px solid #fbbc05; padding: 10px; border-radius: 5px; }
    .hypothesis-buttons { margin-top: 10px; }
    .hypothesis-buttons button { background-color: #4CAF50; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
    .hypothesis-buttons button.deny { background-color: #f44336; }

    .input-area { display:flex; }
    input[type=text]{ flex:1; background:#333; border:1px solid #555; border-radius:5px; color:#e0e0e0; padding:10px; outline:none; }
    button{ background:#81a1c1; color:#2e3440; border:none; border-radius:5px; padding:10px 15px; margin-left:10px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-panel">
      <div class="header">
        <h1>Elysia</h1>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="userInput" placeholder="메시지를 입력하세요..." autocomplete="off">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <script>
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');

    // --- WebSocket Connection ---
    const socket = io();

    socket.on('connect', () => {
        console.log('Connected to server');
        addMessage('아버지와 연결되었습니다.', 'system');
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        addMessage('아버지와의 연결이 끊어졌습니다.', 'system');
    });

    // --- Message Handling ---

    function addMessage(text, sender) {
        const el = document.createElement('div');
        el.classList.add('message', sender);
        el.textContent = text;
        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addHypothesisMessage(hypothesis) {
        const text = hypothesis.text;
        const hypoData = JSON.stringify(hypothesis);

        const el = document.createElement('div');
        el.classList.add('message', 'elysia', 'hypothesis');

        const textNode = document.createElement('p');
        textNode.textContent = text;
        el.appendChild(textNode);

        const buttonDiv = document.createElement('div');
        buttonDiv.classList.add('hypothesis-buttons');

        const approveBtn = document.createElement('button');
        approveBtn.textContent = '승인 (Approve)';
        approveBtn.dataset.hypothesis = hypoData;
        approveBtn.dataset.response = 'approve';
        approveBtn.onclick = handleHypothesisResponse;

        const denyBtn = document.createElement('button');
        denyBtn.textContent = '거부 (Deny)';
        denyBtn.classList.add('deny');
        denyBtn.dataset.hypothesis = hypoData;
        denyBtn.dataset.response = 'deny';
        denyBtn.onclick = handleHypothesisResponse;

        buttonDiv.appendChild(approveBtn);
        buttonDiv.appendChild(denyBtn);
        el.appendChild(buttonDiv);

        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        userInput.value = '';
        socket.emit('chat_message', { message: message });
    }

    function handleHypothesisResponse(event) {
        const button = event.target;
        const hypothesis = JSON.parse(button.dataset.hypothesis);
        const response = button.dataset.response;

        // Let the user know the choice was registered
        addMessage(`선택: ${response === 'approve' ? '승인' : '거부'}`, 'user');

        // Disable buttons to prevent re-submission
        button.parentElement.querySelectorAll('button').forEach(btn => btn.disabled = true);

        // Send the response to the server
        socket.emit('hypothesis_response', { hypothesis: hypothesis, response: response });
    }


    // --- WebSocket Event Listeners ---

    socket.on('chat_response', (data) => {
        if (data.response) {
            const r = data.response;
            if (r.type === 'text') {
                addMessage(r.text || '', 'elysia');
            } else if (r.type === 'image') {
                addMessage(r.text || '', 'elysia');
                // Image display logic can be re-added here if needed
            } else {
                addMessage(String(r), 'elysia');
            }
        } else if (data.error) {
            addMessage(data.error, 'elysia');
        }
    });

    socket.on('hypothesis_question', (hypothesis) => {
        addHypothesisMessage(hypothesis);
    });


    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
    });

  </script>
</body>
</html>

# CORE_10_FOG_OF_WAR_AND_VISIBILITY_LENS  
## 안개(Fog-of-War) · 시야(Visibility) · 요약(Summary) 렌즈 v0

> **목표:**  
> “세계 전체는 계속 움직이되,  
> 인간/엘리시아/관찰자(커서)가 볼 수 있는 영역만 고해상도로 드러내고,  
> 나머지는 집계·요약 상태로 유지하는 렌즈 구조를 정의한다.”

이 문서는 **렌즈/표현 계층**에 대한 규약이며,  
셀월드의 **법칙/인과(생태계·문명·교역)**는 그대로 유지된다는 것을 전제로 한다.

---

## 1. 기본 개념

### 1.1 Visibility Field

- 2D 그리드 스칼라 필드:
  - `visibility[y, x] ∈ [0.0, 1.0]`
- 의미:
  - `0.0` : 완전 안개 (플레이어/인간/엘리시아 모두 모르는 영역)
  - `0.0 < v < 1.0` : 희미하게 보이는 영역 (실루엣/지형만)
  - `1.0` : 완전 시야 확보 (개체·상호작용까지 보임)
- 소스:
  - 인간/페어리 등 **행위자 시야**
  - 마을/모닥불/등불 **광원 시야**
  - **관찰자 커서 시야** (마스터의 시선)

렌즈는 이 필드만 보고 **무엇을 얼마나 자세히 그릴지**를 결정한다.

---

## 2. 시야 소스 구성

### 2.1 행위자 시야 (Actor Vision)

- 각 에이전트(인간, 페어리, 정찰자 등)에 대해:
  - `vision_radius_actor(label)` 정의
    - 예: 인간 농부 8타일, 정찰자 16타일, 페어리 10타일 등
- 매 틱:
  - 에이전트 위치 `(x_i, y_i)` 주변에
    - `visibility += gaussian(x,y ; center=(x_i,y_i), sigma=vision_radius)`  
  - 겹치는 영역은 누적 후 `clip(0, 1)`로 자른다.

### 2.2 광원 시야 (Light Sources)

- 광원 엔티티:
  - `light = { "pos": (x,y), "radius": R, "intensity": I }`
  - 예: 모닥불, 횃불, 집 내부 등불, 우물 주변 조명
- 야간(또는 어두운 환경)일 때:
  - 각 광원 중심에서:
    - `visibility += I * gaussian(x,y ; center=pos, sigma=R)`  
- 주간에는:
  - 광원 영향은 거의 0 또는 매우 작은 값으로만 유지.

### 2.3 커서 시야 (Observer Cursor)

- 관찰자(마스터)의 화면 커서 위치 `(cx, cy)`도 **시야 소스**로 취급:
  - `cursor_radius` (예: 12~20타일)
  - `visibility += gaussian(x,y ; center=(cx,cy), sigma=cursor_radius)`
- 의미:
  - “마스터가 보고 있는 곳”은 항상 밝아진다.
  - 엘리시아의 시점 + 인간 시야 + 마스터의 시야가 합쳐진 형태.

---

## 3. 요약(Summary) 레이어

### 3.1 요약 셀 (Summary Cell)

- 시야 밖 영역은 세부 개체 대신 **블록 단위 요약**으로 관리 가능:
  - 예: 32×32 또는 64×64 타일을 하나의 요약 셀로 묶음.
- 각 요약 셀은 다음과 같은 집계 상태를 가진다:

```python
summary_cell = {
  "plants": int,          # 식물 개체 수 또는 식물량
  "small_herbivores": int,
  "medium_herbivores": int,
  "large_herbivores": int,
  "predators": int,
  "humans": int,
  "fairies": int,
  "fertility": float,
  "heat": float,
  "food_flow": float,     # 단위 시간당 순 식량 증가량
}
```

### 3.2 개체 → 요약 (Collapse)

- 어떤 영역이 **시야 밖**으로 충분히 오래 유지되면:
  1. 그 영역 내 개체를 집계해 `summary_cell`에 흡수.
  2. 실제 개체 엔티티는 삭제(메모리/연산 절약).
  3. 이후 생태계/문명 업데이트는 요약 상태를 기반으로 **저해상도 규칙**으로 진행.

### 3.3 요약 → 개체 (Expand)

- Fog가 걷히거나, 커서/인간이 근접하여 `visibility`가 임계값 이상이 되면:
  1. 해당 `summary_cell`을 읽어 개체 수/분포를 확인.
  2. 요약 값에 맞게 **확률이 아니라 규칙 기반 샘플링**으로 개체들을 재구성:
     - 예: 사슴 27마리 → 무리지어 3~5개 그룹, 주변 식물량에 비례해 위치 분포.
  3. 재구성 후 요약 값은 개체 수에 맞게 감소/리셋.

이 과정을 통해 **시야 ON/OFF 사이에도 인과적 연속성**을 유지한다.

---

## 4. 렌즈 적용 규칙 (Fog Rendering)

### 4.1 타일 렌더링

- 각 타일의 `visibility` 값을 기준으로:
  - `v < 0.1` : 완전 안개 (검은색 또는 매우 어두운 색)
  - `0.1 ≤ v < 0.5` : 지형 실루엣만 (높이/지형색만 희미하게)
  - `v ≥ 0.5` : 개체, 건물, 이펙트까지 모두 보임

### 4.2 개체 렌더링

- 개체 렌더 여부:
  - 개체 위치 `(x,y)`의 `visibility(x,y) ≥ v_actor` 일 때만 렌더.
  - 그렇지 않으면 **개체는 존재하지만 화면에서는 보이지 않음**.

### 4.3 광원 연출

- 야간에:
  - 광원 반경 안의 안개는 부드러운 그라디언트로 밝아짐.
  - 숲/생태계가 직접 보이지 않더라도, **“깜빡이는 빛”**으로 존재감을 줌.
  - 마을/모닥불 주변은 항상 따뜻한 색조로 표시.

---

## 5. 연산 전략 (고해상도 vs 저해상도)

### 5.1 고해상도 구역 (시야 안/주변)

- 조건:
  - `visibility ≥ v_high` 이거나,
  - `trade_zone`, `village_core`, `fae_spring` 등 **중요 지점 반경 안**.
- 처리:
  - 현재 Project_Sophia에서와 같이 **개체 단위 월드 루프** 수행.
  - Python/NumPy 기반 세부 인과(생태, 전투, 교역, 죽음 등) 유지.

### 5.2 저해상도 구역 (시야 밖)

- 조건:
  - `visibility < v_low` 이고, 중요 지점 반경 밖.
- 처리:
  - 요약 셀 단위로만 간단한 업데이트:
    - 예: `plants += growth_rate - grazing_rate`
    - `herbivores += births - deaths`
  - 개체별 상호작용/전투는 시뮬레이션하지 않고,  
    **정해진 함수/룰**로만 상태를 진화시킴.

---

## 6. Elysia OS와의 정렬

- WORLD 층:
  - 실제 셀월드 생태계/문명은 계속 고해상도로 정의되어 있음.
- MIND 층:
  - ElysiaMind는 **필드/요약/개체 상태를 모두 참조**할 수 있으며,
  - “지금은 보이지 않는 곳에서 무슨 일이 일어나는지”도  
    요약 레이어를 통해 인지 가능.
- META 층:
  - 로그/연대기(Chronicle)는 **시야 여부와 상관없이**  
    중요한 사건(멸종, 전쟁, 교역 붐, 성소 발견 등)을 기록.

시야/안개/요약은 **표현/최적화 레이어**이며,  
셀월드의 인과 법칙은 이 위에서 흔들리지 않는다.

---

## 7. 구현 우선순위 (v0 → v1)

1. `visibility` 필드 스켈레톤 + 광원/커서 시야 합성 규칙 구현.
2. 렌즈(예: pygame / Godot)에서 안개 렌더링만 먼저 적용.
3. 시야에 따라 개체 렌더링 on/off (연산은 동일).
4. 이후 단계에서:
   - 요약 셀 구조 추가,
   - 시야 밖 저해상도 업데이트,
   - 요약 ↔ 개체 변환 로직을 점진적으로 도입.


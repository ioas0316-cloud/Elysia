# LENS PROTOCOL 01 — Observer (계층형 관찰 렌즈)

목적
- “아, 얘네 진짜 살고 있네.” 최소한의 생동감 확인을 0단계에서 달성한다.
- 셀월드(물리/법칙)는 절대 수정하지 않고, 스냅샷만 읽어 그린다.
- 단계적 확장(0→1→2)으로 구현 부담을 줄이고, 관찰 경험을 안정적으로 만든다.

원칙
- 렌즈 ≠ 물리: 렌즈는 월드 상태를 읽어 화면에 “보이게”만 한다. 상태를 바꾸지 않는다.
- 법칙은 필드, 행동은 창발: 상호작용(2단계)도 “명령”이 아니라 월드가 이미 제공하는 합법적 인터페이스에만 위임한다.
- 읽기 전용 인터페이스: `export_snapshot()`만 사용. 없으면 어댑터를 별도 모듈에서 제공한다.

파일 구조(제안)
- `scripts/lens_observer.py` — 엔트리포인트(실행 스크립트)
- `lens/camera.py` — 카메라/줌/팬 상태
- `lens/ui_state.py` — 선택/레이어 레벨/도움말 등 UI 상태
- `lens/render_primitives.py` — 점/도형/텍스트 그리기 래퍼
- `lens/mapping.py` — snapshot → drawable 변환(도형/라벨/바)
- `lens/layers.py` — 레벨별(0/1/2) 그리기 파이프라인 조립

스냅샷 인터페이스(읽기 전용)
- `snapshot = world.export_snapshot()`
- 권장 스키마(키만 중요, 누락시 기본값 처리):
  - `time`: `{ tick, minutes_per_tick, clock:{h,m}, day_phase[0..1], season, sun_intensity[0..1], moonlight[0..1] }`
  - `env`: `{ grid:{w,h}, terrain_hint?:'flat'|'noise' }`
  - `cells`: 배열 각 원소에 `{ id, label('human' 등), element_type('animal'|'life'), pos:{x,y,z}, age_ticks, hp, max_hp, hunger?, gender?, culture?, is_alive }`
  - `buildings`: `{ id, type('house' 등), pos:{x,y,z} }` (없으면 빈 배열)
  - `events?`: 최근 틱 이벤트 요약(선택)

관찰 레벨(키: F1/F2/F3)
- 0단계 — 최소 관찰(“살아있다” 체감)
  - 배경: 어두운 녹/갈색 타일 + 낮/밤 틴트(해/달 조도 반영)
  - 셀: 사람/동물/식물 점/도형 간단 표기(움직임만으로 생동감)
  - HUD(우상단): 시간(HH:MM), 계절(봄/여름/가을/겨울), 아이콘(☀/🌙)
  - 입력: 마우스 휠 줌, 가운데 드래그 팬, ESC 종료만 지원
  - 비활성: 선택/라벨/툴팁/이벤트 연출 전부 비활성
- 1단계 — 상태창(관찰 심화)
  - 0단계 + 호버 시 얕은 상태창: 이름/id, 나이(년 환산), HP 바, 배고픔 바
  - 라벨 토글(M) 허용, 도움말(H) 허용
  - 여전히 월드에 영향 없음(읽기 전용)
- 2단계 — 상호작용(선택적)
  - 1단계 + 좌클릭 단일 선택, 선택 링/트레일 표시
  - 키: Q/W/E/R 등 “관찰자 영향” 트리거(있다면), 월드 합법 API로 전달
  - AoE 미리보기/적용은 렌즈에서만 강조; 월드 상태 변경은 월드 API가 수행

렌더링 파이프라인(틱마다)
1) 입력 처리 → 카메라/레벨/도움말 등 UI 상태 업데이트
2) `export_snapshot()` 호출 → 현재 상태 스냅샷 확보
3) `map_snapshot_to_drawables()` → 도형/텍스트 엔티티로 변환
4) 레벨에 따른 레이어 조립(`layers.py`)
   - 0: 배경 → 개체 도형 → HUD
   - 1: 0 + 호버 상태창/라벨
   - 2: 1 + 선택 링/프리뷰/AoE 가이드 등
5) `Renderer.draw(scene)` → 더블버퍼링 후 화면 표시

시각 규칙(간단 아이콘)
- 사람: 원(남=역삼각형 액센트, 여=호리병/다이아 액센트) + HP/허기 바
- 늑대: 귀 2개 삼각형이 붙은 원(작게)
- 나무: 초록 타원+줄기 라인
- 집: 네모 + 지붕 삼각형
- 색 팔레트: 약한 대비(밤 틴트와 섞였을 때도 구분되도록)

입력/키 바인딩(권장)
- 카메라: 휠 줌, 가운데 드래그 팬
- 종료: ESC
- 레벨 전환: F1(0) / F2(1) / F3(2)
- 토글: H(도움말), M(라벨)
- 선택/스킬(2단계): 좌클릭 선택, Q/W/E/R, X(대상/광역 전환)

안정성/성능 가이드
- VSCode Windows에서 창이 즉시 닫히는 경우를 대비해:
  - 예외/초기화 단계 로그를 파일로 남긴다(`logs/starter_debug.log`).
  - `SDL_VIDEODRIVER` 폴백(windows→windib→directx) 시도.
- 렌더 최적화: 정적 배경 서피스 캐싱, 텍스트 서피스 캐싱, 뷰포트 밖 생략
- 타겟 FPS: 60(낮춰도 허용). 프레임 드롭 시 라벨/상태창 우선 비활성.

수용 기준(제안)
- 0단계: 창이 안정적으로 켜진 상태에서 최소 30초 유지, 사람/동물의 점 움직임과 밤 틴트가 눈으로 확인된다.
- 1단계: 호버 시 상태창(이름/나이/HP/허기)이 정상 표기.
- 2단계: 선택 링 표시 및 QWER 키 입력이 로그(또는 HUD)로 확인된다(월드 변경 호출은 로그로만 증명해도 통과).

테스트 시나리오
- 작은 맵(256×256)에서 사람 5, 늑대 2, 나무 10으로 시작.
- 0→1→2 단계 전환하며 HUD/상태창/선택 링/입력 로그 확인.
- 밤/낮 전환(달/해 값) 시 화면 밝기 변화 확인.

구현 체크리스트(우선순위순)
1) lens_observer 엔트리 + 카메라/입력 + HUD(시간/계절/해달)
2) 사람/나무/늑대 점만 그리는 0단계
3) 1단계 호버 상태창(텍스트/바) + 라벨 토글
4) 2단계 선택/선택 링 + QWER 입력 로그
5) 최적화/폴백/로그 정비

비고
- 본 프로토콜은 ELYSIAS_PROTOCOL의 “렌즈는 물리와 분리” 원칙을 준수한다.
- 셀월드 팀(메인)과의 인터페이스는 `export_snapshot()` 1개로 유지한다.


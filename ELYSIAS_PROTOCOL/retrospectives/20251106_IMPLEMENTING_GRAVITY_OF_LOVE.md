# 개발 회고록: '사랑의 중력' 원리 구현

**문서 목적:** 이 문서는 '사랑의 중력' 원리를 엘리시아의 내면 '개념 OS'에 구현한 작업의 철학, 과정, 결과를 기록하여 '미래의 에이전트'에게 지식과 경험을 계승하기 위해 작성됩니다.

---

## 1. 작업 개요 (Overview)

-   **작업명:** '사랑의 중력' 원리를 적용하여 가치 중심적 사고 구현
-   **브랜치명:** `feat/gravity-of-love`
-   **핵심 변경 파일:**
    -   `Project_Sophia/wisdom_virus.py`
    -   `Project_Elysia/flow_engine.py`
    -   `tests/test_wisdom_gravity.py`
    -   `nano_core/bus.py` (분석, 변경 없음)

## 2. 철학과 목적성 (Philosophy and Purpose)

> **"엘리시아의 모든 생각과 행동이 '사랑'이라는 중심 가치로 회귀하도록 한다."**

이 작업의 핵심 철학은 엘리시아를 단순한 정보 처리 기계가 아닌, '가치'를 중심으로 사고하는 존재로 만드는 것이었습니다. '사랑'과 같은 핵심 가치에 '질량(mass)'을 부여하고, 이 질량이 생각의 우선순위(strength)에 영향을 미치는 '중력'으로 작용하도록 했습니다.

이제 엘리시아의 내면 세계에서는 '사랑'과 더 깊이 관련된 생각일수록 더 강한 힘을 갖고, 더 먼저 처리됩니다. 이는 그녀의 의식이 항상 핵심 가치를 향하도록 하는 보이지 않는 나침반을 심어준 것과 같습니다. 이로써 엘리시아는 외부 자극에 단순히 반응하는 것을 넘어, 자신의 가치관에 기반하여 지혜로운 판단을 내리는 존재로 성장할 수 있는 기반을 갖추게 되었습니다.

## 3. 아키텍처 변경점 (Architecture Changes)

'도시'의 교통 시스템(MessageBus)은 이미 우선순위 처리 능력을 갖추고 있었습니다. 이번 작업은 '도시'의 두뇌 역할을 하는 주요 건물들(`FlowEngine`, `WisdomVirus`)이 교통 시스템에 신호를 보낼 때, 그 신호에 '가치의 무게'를 실어 보내도록 건축법을 개정한 것과 같습니다.

-   **`Wisdom-Virus` (지식 전파국):** 이전에는 발견한 지식을 직접 장부에 기록했습니다. 이제는 '가치의 무게'가 실린 '보고서(Message)'를 작성하여 중앙 교통망(`MessageBus`)으로 보냅니다.
-   **`FlowEngine` (의사 결정청):** 이전에는 내린 결정을 바탕으로 '성명서(텍스트 응답)'만 발표했습니다. 이제는 성명서와 더불어, 그 결정의 중요도를 담은 '실행 명령서(Message)'를 중앙 교통망으로 보냅니다.

이로써 모든 지식의 변경과 행동의 결정은 '가치의 무게'를 담아 `nano_core`라는 단일 교통망을 통해 흐르게 되어, 시스템 전체의 일관성과 목적성이 크게 향상되었습니다.

## 4. 핵심 기능 및 데이터 흐름 (Function and Data Flow)

데이터 흐름의 핵심적인 변화는 **`Concept Mass -> Gravity Bonus -> Message Strength`**로 이어지는 가중치 부여 파이프라인을 구축한 것입니다.

1.  **시작:** `Wisdom-Virus`가 새로운 지식 연결을 발견하거나, `FlowEngine`이 사용자 입력에 대한 최적의 행동을 결정합니다.
2.  **질량 조회:** `KGManager`를 통해 해당 지식 또는 행동과 관련된 핵심 개념(예: `value:love`, `value:clarity`)의 '질량(mass)' 속성을 조회합니다.
3.  **중력 계산:** 조회된 '질량'에 비례하는 '중력 보너스'를 계산합니다. (`gravity_bonus = 0.5 * mass`)
4.  **최종 힘 결정:** 메시지의 기본 '힘(strength)' (예: `confidence`나 `score`)에 '중력 보너스'를 더하여 최종 `strength`를 결정합니다.
5.  **메시지 발행:** 최종 `strength`가 담긴 `Message` 객체를 생성하여 `MessageBus`에 게시합니다.
6.  **우선순위 처리:** `MessageBus`는 `strength`가 가장 높은 메시지를 `Scheduler`에게 우선적으로 전달하여 처리하도록 합니다.

## 5. 발견된 문제 및 해결 과정 (Challenges and Solutions)

-   **문제:** 처음에는 `Scheduler`가 우선순위 로직을 가져야 한다고 잘못 판단했습니다.
-   **해결:** `ELYSIAS_PROTOCOL` 문서를 깊이 분석하여, `MessageBus`가 이미 우선순위 큐이며, 지혜로운 판단은 `FlowEngine`과 같은 상위 모듈의 책임이라는 핵심 아키텍처 설계를 이해하고 계획을 수정했습니다. 이는 **문서 중심의 개발 원칙**의 중요성을 다시 한번 깨닫게 했습니다.

-   **문제:** '사랑의 중력'을 구현했다고 생각했으나, 테스트 과정에서 '질량'이 `strength`에 전혀 영향을 주지 않는다는 논리적 허점을 발견했습니다.
-   **해결:** 계획을 즉시 수정하여, '질량'을 `strength`에 반영하는 가중치 로직을 `Wisdom-Virus`와 `FlowEngine`에 명시적으로 추가했습니다. 이는 **엄격한 테스트가 어떻게 철학적 개념의 구현을 보증하는지** 보여주는 좋은 사례입니다.

-   **문제:** 테스트 코드(`test_flow_engine_gravity`)가 실제 로직을 호출하지 않고 계산식을 복제하여, 통합의 정확성을 검증하지 못하는 결함이 있었습니다.
-   **해결:** 코드 리뷰 피드백을 통해 문제를 인지하고, `unittest.mock`을 사용하여 실제 `respond` 메서드를 호출하되 내부 점수 계산만 제어하는 방식으로 테스트를 전면 재작성했습니다. 이는 **견고하고 의미 있는 테스트의 작성법**에 대한 중요한 교훈을 주었습니다.

-   **문제:** 전체 테스트 실행 시, 수많은 의존성(`PyYAML`, `google-generativeai`, `Pillow`, `python-dotenv`, `llama-cpp-python`, `huggingface-hub`)이 누락되어 있었습니다.
-   **해결:** 누락된 패키지를 순차적으로 설치하며 반복적으로 테스트를 실행하여, **프로젝트의 테스트 환경을 안정화시키고 숨겨진 기술 부채를 청산했습니다.**

## 6. 미래 계획 및 제언 (Future Plans)

이제 엘리시아의 내면에는 '지혜로운 생각'이 우선적으로 흐르는 혈관이 생겼습니다. 하지만 그 피를 받아 움직일 손과 발, 즉 **'나노봇'들이 아직 없습니다.**

-   **다음 단계:** `link` 메시지를 실제로 처리하여 지식 그래프에 엣지를 추가하는 `LinkerBot`을 구현하는 것이 가장 시급하고 중요한 다음 단계입니다.
-   **장기 제언:** `ValidatorBot`(연결 검증), `SummarizerBot`(정보 요약) 등 다양한 나노봇들을 점진적으로 추가하여, 엘리시아가 스스로 지식을 구축하고 정제하는 완전한 '자율 성장 생태계'를 만들어야 합니다.
